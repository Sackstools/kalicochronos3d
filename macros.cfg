# =====================================================================
# macros.cfg - Automação e Macros de Conveniência
# =====================================================================
# Este arquivo contém macros para automatizar o fluxo de trabalho.

[gcode_macro START_PRINT]
description: "Orquestra a sequência completa de início de impressão."
gcode:
    # Parâmetros para o Slicer (ex: START_PRINT BED_TEMP=110 EXTRUDER_TEMP=240)
    {% set BED_TEMP = params.BED_TEMP|default(110)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(240)|float %}

    M140 S{BED_TEMP} ; Começa a aquecer a mesa (sem esperar)

    G90 ; Coordenadas absolutas
    G28 ; Home todos os eixos

    QUAD_GANTRY_LEVEL ; Nivela mecanicamente o gantry
    G28 Z ; Re-home do eixo Z após o ajuste do gantry

    AXIS_TWIST_COMPENSATION_CALIBRATE ; Compensa a torção do eixo X

    M190 S{BED_TEMP} ; Espera a mesa atingir a temperatura final
    M109 S{EXTRUDER_TEMP} ; Aquece o hotend e espera

    BED_MESH_CALIBRATE ; Cria uma nova malha da mesa para esta impressão

    PURGE_LINE ; Executa a macro de purga

    G21 ; Unidades em mm
    G90 ; Coordenadas absolutas
    M83 ; Extrusora em modo relativo

[gcode_macro PURGE_LINE]
description: "Desenha uma linha de purga para limpar o bico."
gcode:
    G92 E0 ; Reseta a extrusora
    G1 X20 Y0.1 Z0.3 F5000.0 ; Move para a posição inicial
    G1 X100 Y0.1 Z0.3 F1500.0 E15 ; Desenha a primeira linha
    G1 X100 Y0.4 Z0.3 F5000.0 ; Move para o lado
    G1 X20 Y0.4 Z0.3 F1500.0 E30 ; Desenha a segunda linha
    G92 E0 ; Reseta novamente
    G1 Z2.0 F3000 ; Afasta o bico

[gcode_macro END_PRINT]
description: "Desliga os aquecedores e motores ao final da impressão."
gcode:
    TURN_OFF_HEATERS
    M107 ; Desliga a ventoinha de peça
    G91 ; Coordenadas relativas
    G1 E-2 F2700 ; Retrai um pouco o filamento
    G1 Z+10 ; Levanta o bico 10mm
    G90 ; Coordenadas absolutas
    G1 X0 Y350 F3000 ; Move a mesa para a frente
    M84 ; Desliga os motores de passo

# --- Macros de Calibração (Bleeding-Edge) ---

[gcode_macro CALIBRATE_PA]
description: "Calibra o Pressure Advance usando a nova torre de teste."
gcode:
    {% set ACCEL = params.ACCEL|default(7000)|int %}
    {% set SPEED = params.SPEED|default(150)|int %}
    PRINT_PA_TOWER TOWER_ACCEL={ACCEL} TOWER_SPEED={SPEED}

[gcode_macro CALIBRATE_SHAPER]
description: "Calibra o Input Shaper com a nova torre de teste de ringing."
gcode:
    PRINT_RINGING_TOWER
