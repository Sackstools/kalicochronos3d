# =====================================================================
# macros-btt-octopus-max-ez.cfg - Automação para Crossed Gantry (CORRIGIDO)
# =====================================================================

# --- Macro de Início de Impressão ---
[gcode_macro START_PRINT]
description: "Orquestra a sequência completa de início de impressão."
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(110)|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(240)|float %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(60)|float %}

    M140 S{BED_TEMP} ; Começa a aquecer a mesa
    SET_HEATER_TEMPERATURE HEATER=chamber TARGET={CHAMBER_TEMP} ; Começa a aquecer a câmara

    # Com a configuração de hardware correta, o Klipper gerencia o homing dos motores duplos.
    # A sequência recomendada é Y, depois X, depois Z.
    G28 Y0
    G28 X0
    G28 Z0

    Z_TILT_ADJUST ; Nivela o eixo Z usando os 3 motores

    G28 Z0 ; Re-home do Z após o Z-Tilt para máxima precisão

    M190 S{BED_TEMP} ; Espera a mesa atingir a temperatura
    SET_HEATER_TEMPERATURE HEATER=chamber TARGET={CHAMBER_TEMP} ; Garante que a câmara está na temperatura
    M109 S{EXTRUDER_TEMP} ; Aquece o hotend e espera

    BED_MESH_CALIBRATE ; Cria a malha da mesa

    PURGE_LINE ; Executa a linha de purga

# --- Macros Padrão ---
[gcode_macro PURGE_LINE]
description: "Desenha uma linha de purga para limpar o bico."
gcode:
    G92 E0
    G1 X50 Y5 Z0.4 F6000
    G1 X250 Y5 Z0.4 F1500 E15
    G92 E0

[gcode_macro END_PRINT]
description: "Desliga os aquecedores e motores ao final da impressão."
gcode:
    TURN_OFF_HEATERS
    M107
    G91
    G1 E-2 F2700
    G1 Z+10 F3000
    G90
    G1 X0 Y600 F3000
    M84

# --- Macros de Calibração (Bleeding-Edge) ---
[gcode_macro CALIBRATE_PA]
description: "Calibra o Pressure Advance usando a nova torre de teste."
gcode:
    {% set ACCEL = params.ACCEL|default(7000)|int %}
    {% set SPEED = params.SPEED|default(150)|int %}
    PRINT_PA_TOWER TOWER_ACCEL={ACCEL} TOWER_SPEED={SPEED}

[gcode_macro CALIBRATE_SHAPER]
description: "Calibra o Input Shaper com a nova torre de teste de ringing."
gcode:
    PRINT_RINGING_TOWER
